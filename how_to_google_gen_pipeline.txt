#################################################################################

# How to build a custom docker image, and run a custom script with
# Google Genomics Pipelines
# David L Gibbs
# dgibbs@systemsbiology.org
# November 6, 2017

# https://cloud.google.com/genomics/overview

#################################################################################

# 1. I searched for 'docker and R stan' and found some docker recipes.

# 2. I'm going to revise this docker file:
# https://github.com/jburos/rstan-docker/blob/master/Dockerfile
# I'm going to edit that file, by:
# -- changing the Maintainer.
# -- adding my own script from my github repo
# See the Dockerfile in this repo.

# 3. Now I'm going to edit the example pipeline file
# https://cloud.google.com/genomics/v1alpha2/pipelines
# see standocker-pipeline.yaml

# 3. Now we call the genomics pipeline to run it.
# https://cloud.google.com/genomics/install-genomics-tools

gcloud alpha genomics pipelines run \
--pipeline-file standocker-pipeline.yaml \
--inputs INPUT_FILE=gs://gibbs_bucket_nov162016/data/data_file_1.csv \
--inputs INPUT_SCRIPT=gs://gibbs_bucket_nov162016/logistic_regression_ref_man.R \
--outputs OUTPUT_FILE=gs://gibbs_bucket_nov162016/stan_output/stan_out_in_cmd.png \
--logging gs://gibbs_bucket_nov162016/logs/

# OK, it returns saying:
Running [operations/ENGopaL5KxiThuH18PenvxAg6YmPu4QUKg9wcm9kdWN0aW9uUXVldWU].

# We can check it's status with:
gcloud alpha genomics operations describe operations/ENGopaL5KxiThuH18PenvxAg6YmPu4QUKg9wcm9kdWN0aW9uUXVldWU

davidgibbs@pear ~/C/DockerExpr> gcloud alpha genomics operations describe operations/ENGRyN6LKxib783r--jChQcg6YmPu4QUKg9wcm9kdWN0aW9uUXVldWU
done: true
metadata:
  '@type': type.googleapis.com/google.genomics.v1.OperationMetadata
  clientId: ''
  createTime: '2016-12-01T19:17:34Z'
  //etc//

# and if we/I forget the job ID, we can check using:
gcloud alpha genomics operations list | less

# Now, we can check our bucket for the output.
# DONE!
